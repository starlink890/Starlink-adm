<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Starlink - Terminal Ma√Ætre</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #050a14; color: white; padding: 20px; }
        .panel { background: #0a1220; border: 1px solid #00d2ff; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 0 20px rgba(0, 210, 255, 0.1); }
        h1 { text-align: center; color: #00d2ff; letter-spacing: 2px; }
        h2 { color: #00d2ff; border-bottom: 1px solid rgba(0, 210, 255, 0.3); padding-bottom: 10px; font-size: 18px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: rgba(255,255,255,0.02); }
        th, td { border: 1px solid #1a2a40; padding: 12px; text-align: left; font-size: 14px; }
        th { background: #00d2ff; color: black; text-transform: uppercase; }
        .btn-valider { background: #4caf50; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-delete { background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-left: 5px; }
        tr:hover { background: rgba(0, 210, 255, 0.05); }
        .empty-msg { text-align: center; padding: 20px; opacity: 0.5; font-style: italic; }
    </style>
</head>
<body>

    <h1>üõ∞Ô∏è CENTRE DE CONTR√îLE STARLINK</h1>

    <div class="panel">
        <h2>üì• DEMANDES DE RECHARGE (D√âP√îTS)</h2>
        <table>
            <thead>
                <tr>
                    <th>T√©l√©phone</th>
                    <th>Montant</th>
                    <th>ID Transaction</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="bodyRecharges"></tbody>
        </table>
    </div>

    <div class="panel">
        <h2>üì§ DEMANDES DE RETRAIT</h2>
        <table>
            <thead>
                <tr>
                    <th>T√©l√©phone</th>
                    <th>Montant</th>
                    <th>M√©thode / Num√©ro</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="bodyRetraits"></tbody>
        </table>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, remove, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA24pBo8mBWiZssPtep--MMBdB7c8_Lu4U",
        authDomain: "starlink-investit.firebaseapp.com",
        databaseURL: "https://starlink-investit-default-rtdb.firebaseio.com",
        projectId: "starlink-investit",
        storageBucket: "starlink-investit.firebasestorage.app",
        messagingSenderId: "807081599583",
        appId: "1:807081599583:web:e00ec3959bc4acdae031ea"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- CHARGEMENT DES RECHARGES ---
    onValue(ref(db, 'demandes_recharges'), (snap) => {
        const tbody = document.getElementById("bodyRecharges");
        tbody.innerHTML = "";
        if (!snap.exists()) {
            tbody.innerHTML = "<tr><td colspan='4' class='empty-msg'>Aucune demande de recharge en attente</td></tr>";
            return;
        }
        snap.forEach(child => {
            const data = child.val();
            const row = `<tr>
                <td><b>${data.telephone}</b></td>
                <td style="color:#4caf50; font-weight:bold;">${parseInt(data.montant).toLocaleString()} FC</td>
                <td><small>${data.transactionID}</small></td>
                <td>
                    <button class="btn-valider" onclick="validerRecharge('${data.telephone}', ${data.montant}, '${child.key}')">Valider</button>
                    <button class="btn-delete" onclick="supprimerDemande('demandes_recharges', '${child.key}')">Rejeter</button>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });
    });

    // --- FONCTION VALIDER RECHARGE ---
    window.validerRecharge = async (phone, montant, key) => {
        if (confirm(`Confirmer l'ajout de ${montant} FC au compte ${phone} ?`)) {
            const userRef = ref(db, 'users/' + phone);
            try {
                const userSnap = await get(userRef);
                if (userSnap.exists()) {
                    const actuel = userSnap.val().solde_principal || 0;
                    // Mise √† jour du solde et passage du statut en Valid√©
                    await update(userRef, { solde_principal: actuel + parseInt(montant) });
                    await remove(ref(db, 'demandes_recharges/' + key));
                    alert("‚úÖ Compte cr√©dit√© avec succ√®s !");
                } else {
                    alert("‚ùå Utilisateur introuvable.");
                }
            } catch (e) {
                alert("Erreur : " + e.message);
            }
        }
    };

    // --- CHARGEMENT DES RETRAITS ---
    onValue(ref(db, 'demandes_retraits'), (snap) => {
        const tbody = document.getElementById("bodyRetraits");
        tbody.innerHTML = "";
        if (!snap.exists()) {
            tbody.innerHTML = "<tr><td colspan='4' class='empty-msg'>Aucun retrait en attente</td></tr>";
            return;
        }
        snap.forEach(child => {
            const data = child.val();
            const row = `<tr>
                <td><b>${data.telephone}</b></td>
                <td style="color:#f44336; font-weight:bold;">${parseInt(data.montant).toLocaleString()} FC</td>
                <td>${data.methode} : ${data.numero_reception}</td>
                <td>
                    <button class="btn-valider" style="background:#2196F3;" onclick="supprimerDemande('demandes_retraits', '${child.key}', 'Marquer comme pay√© ?')">Pay√©</button>
                    <button class="btn-delete" onclick="supprimerDemande('demandes_retraits', '${child.key}', 'Rejeter le retrait ?')">Rejeter</button>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });
    });

    // --- SUPPRESSION / REJET ---
    window.supprimerDemande = (chemin, key, message = "Supprimer cette demande ?") => {
        if (confirm(message)) {
            remove(ref(db, chemin + '/' + key)).then(() => {
                alert("Demande trait√©e.");
            });
        }
    };
</script>
</body>
</html>
